-- =============================================================
-- THỊNH ĐẸP TRAI - FINAL FIX (AUTO RESPAWN + HARD WALL BLOCK)
-- =============================================================

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

-- 1. DỌN DẸP UI CŨ
if CoreGui:FindFirstChild("ThinhFixed_UI") then
    CoreGui.ThinhFixed_UI:Destroy()
end

-- 2. CẤU HÌNH
local IsEnabled = false
local Speed = 120 
local BodyVel = nil 
local BodyGyro = nil
local BarrierPart = nil 

-- Biến cho Cam
local CamNoClipEnabled = false
local DefaultMaxZoom = 128
local DefaultOcclusion = Enum.DevCameraOcclusionMode.Zoom

-- === [THÔNG SỐ TƯỜNG] ===
local PointA = Vector3.new(135.985291, 3.17998266, 138.032028)
local PointB = Vector3.new(1275.04187, 3.17999005, 137.223465)
local FixedOffset = 4 
local WallHeight = 500
local WallThickness = 4 

-- 3. HÀM DỰNG TƯỜNG
local function CreateFixedWall()
    if Workspace:FindFirstChild("GridBorder") then Workspace.GridBorder:Destroy() end
    local Wall = Instance.new("Part")
    Wall.Name = "GridBorder"; Wall.Anchored = true; Wall.CanCollide = true; Wall.Transparency = 0.5 
    Wall.Color = Color3.fromRGB(0, 255, 255); Wall.Material = Enum.Material.ForceField; Wall.Parent = Workspace
    
    local Distance = (PointA - PointB).Magnitude
    local MidPoint = (PointA + PointB) / 2
    local BaseCFrame = CFrame.lookAt(MidPoint, PointB)
    local RightDir = BaseCFrame.RightVector
    local FinalPos = MidPoint + (RightDir * FixedOffset)
    
    Wall.Size = Vector3.new(WallThickness, WallHeight, Distance)
    Wall.CFrame = CFrame.lookAt(FinalPos, PointB + (RightDir * FixedOffset))
    BarrierPart = Wall
    return Wall
end

-- 4. GIAO DIỆN
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ThinhFixed_UI"; ScreenGui.Parent = CoreGui; ScreenGui.ResetOnSpawn = false 

local OpenBtn = Instance.new("TextButton")
OpenBtn.Parent = ScreenGui; OpenBtn.Text = "MENU"; OpenBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 255); OpenBtn.Size = UDim2.new(0, 60, 0, 30); OpenBtn.Position = UDim2.new(0, 10, 0.5, 0); OpenBtn.Visible = false; Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(0, 8)

local MainFrame = Instance.new("Frame")
MainFrame.Parent = ScreenGui; MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 35); MainFrame.Position = UDim2.new(0.5, -150, 0.3, 0); MainFrame.Size = UDim2.new(0, 300, 0, 250); MainFrame.Active = true; MainFrame.Draggable = true; Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 15); Instance.new("UIStroke", MainFrame).Color = Color3.fromRGB(0, 255, 255); Instance.new("UIStroke", MainFrame).Thickness = 2

local Title = Instance.new("TextLabel"); Title.Parent = MainFrame; Title.Text = "THỊNH ĐẸP TRAI"; Title.Font = Enum.Font.GothamBlack; Title.TextColor3 = Color3.fromRGB(255, 255, 0); Title.TextSize = 18; Title.Size = UDim2.new(1, 0, 0, 60); Title.BackgroundTransparency = 1

local BtnYes = Instance.new("TextButton"); BtnYes.Parent = MainFrame; BtnYes.Text = "BẬT HACK"; BtnYes.BackgroundColor3 = Color3.fromRGB(0, 200, 100); BtnYes.TextColor3 = Color3.fromRGB(255,255,255); BtnYes.Size = UDim2.new(0.4, 0, 0, 40); BtnYes.Position = UDim2.new(0.07, 0, 0.3, 0); Instance.new("UICorner", BtnYes).CornerRadius = UDim.new(0, 8)
local BtnNo = Instance.new("TextButton"); BtnNo.Parent = MainFrame; BtnNo.Text = "TẮT HACK"; BtnNo.BackgroundColor3 = Color3.fromRGB(200, 50, 50); BtnNo.TextColor3 = Color3.fromRGB(255,255,255); BtnNo.Size = UDim2.new(0.4, 0, 0, 40); BtnNo.Position = UDim2.new(0.53, 0, 0.3, 0); Instance.new("UICorner", BtnNo).CornerRadius = UDim.new(0, 8)

local BtnCamHack = Instance.new("TextButton"); BtnCamHack.Parent = MainFrame; BtnCamHack.Text = "CAM XUYÊN TƯỜNG: OFF"; BtnCamHack.BackgroundColor3 = Color3.fromRGB(60, 60, 60); BtnCamHack.TextColor3 = Color3.fromRGB(255,255,255); BtnCamHack.Size = UDim2.new(0.86, 0, 0, 40); BtnCamHack.Position = UDim2.new(0.07, 0, 0.55, 0); Instance.new("UICorner", BtnCamHack).CornerRadius = UDim.new(0, 8); BtnCamHack.Font = Enum.Font.GothamBold

local MiniBtn = Instance.new("TextButton"); MiniBtn.Parent = MainFrame; MiniBtn.Text = "–"; MiniBtn.BackgroundTransparency = 1; MiniBtn.TextColor3 = Color3.fromRGB(255,255,255); MiniBtn.TextSize = 30; MiniBtn.Size = UDim2.new(0, 30, 0, 30); MiniBtn.Position = UDim2.new(1, -30, 0, 0)
MiniBtn.MouseButton1Click:Connect(function() MainFrame.Visible = false; OpenBtn.Visible = true end)
OpenBtn.MouseButton1Click:Connect(function() MainFrame.Visible = true; OpenBtn.Visible = false end)

-- 5. CHỨC NĂNG CỐT LÕI (CORE)

-- Hàm xóa vật lý cũ
local function RemovePhysics(char)
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if root then
        if root:FindFirstChild("ThinhFlyVelocity") then root.ThinhFlyVelocity:Destroy() end
        if root:FindFirstChild("ThinhFlyGyro") then root.ThinhFlyGyro:Destroy() end
    end
end

-- Hàm áp dụng vật lý mới
local function ApplyPhysics(char)
    if not char then return end
    local root = char:WaitForChild("HumanoidRootPart", 5)
    if not root then return end
    
    RemovePhysics(char) -- Xóa cái cũ cho chắc
    
    BodyVel = Instance.new("BodyVelocity")
    BodyVel.Name = "ThinhFlyVelocity"; BodyVel.Parent = root
    BodyVel.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    BodyVel.Velocity = Vector3.zero
    
    BodyGyro = Instance.new("BodyGyro")
    BodyGyro.Name = "ThinhFlyGyro"; BodyGyro.Parent = root
    BodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    BodyGyro.P = 20000
    BodyGyro.CFrame = root.CFrame
end

-- Logic bật/tắt chính
local function ToggleHack(state)
    IsEnabled = state
    if IsEnabled then
        BtnYes.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        BarrierPart = CreateFixedWall()
        ApplyPhysics(LocalPlayer.Character)
    else
        BtnYes.BackgroundColor3 = Color3.fromRGB(30, 100, 50)
        if BarrierPart then BarrierPart:Destroy(); BarrierPart = nil end
        RemovePhysics(LocalPlayer.Character)
        BodyVel = nil; BodyGyro = nil
    end
end

-- Nút bấm
BtnYes.MouseButton1Click:Connect(function() ToggleHack(true) end)
BtnNo.MouseButton1Click:Connect(function() ToggleHack(false) end)

-- Cam Xuyên Tường
BtnCamHack.MouseButton1Click:Connect(function()
    CamNoClipEnabled = not CamNoClipEnabled
    if CamNoClipEnabled then
        BtnCamHack.Text = "CAM XUYÊN TƯỜNG: ON"; BtnCamHack.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    else
        BtnCamHack.Text = "CAM XUYÊN TƯỜNG: OFF"; BtnCamHack.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        LocalPlayer.CameraMaxZoomDistance = DefaultMaxZoom
        LocalPlayer.DevCameraOcclusionMode = DefaultOcclusion
    end
end)

-- 6. TỰ ĐỘNG HỒI SINH (AUTO RESPAWN FIX)
LocalPlayer.CharacterAdded:Connect(function(newChar)
    if IsEnabled then
        -- Đợi character load xong
        task.wait(0.5)
        ApplyPhysics(newChar)
    end
end)

-- 7. VÒNG LẶP XỬ LÝ (TỐI ƯU HÓA)
RunService.Stepped:Connect(function()
    -- Xử lý Cam
    if CamNoClipEnabled then
        LocalPlayer.CameraMaxZoomDistance = 100000
        LocalPlayer.DevCameraOcclusionMode = Enum.DevCameraOcclusionMode.Invisicam
    end

    -- Xử lý Hack
    if IsEnabled and LocalPlayer.Character then
        local char = LocalPlayer.Character
        local root = char:FindFirstChild("HumanoidRootPart")
        local hum = char:FindFirstChild("Humanoid")
        
        -- NOCLIP (Xuyên vật thể)
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") and part.CanCollide then part.CanCollide = false end
        end
        
        -- DI CHUYỂN + CHẶN TƯỜNG
        if root and hum and BodyVel and BodyVel.Parent == root and BarrierPart then
            local moveDir = hum.MoveDirection
            local targetVelocity = Vector3.zero
            
            if moveDir.Magnitude > 0 then
                targetVelocity = Vector3.new(moveDir.X * Speed, 0, moveDir.Z * Speed)
                
                -- [[ LOGIC CHẶN TƯỜNG NÂNG CAO ]]
                -- Tính khoảng cách tương đối với tường
                local relCF = BarrierPart.CFrame:ToObjectSpace(root.CFrame)
                local distToCenter = relCF.Position.X -- Khoảng cách theo trục X của tường
                local safeZone = (WallThickness / 2) + 2 -- Vùng an toàn
                
                -- Nếu đang ở TRONG vùng tường
                if math.abs(distToCenter) < safeZone then
                    -- 1. Đẩy lùi lại ngay lập tức (Teleport nhẹ)
                    local pushDir = (distToCenter > 0) and 1 or -1
                    local fixPos = Vector3.new(safeZone * pushDir, relCF.Position.Y, relCF.Position.Z)
                    root.CFrame = BarrierPart.CFrame:ToWorldSpace(CFrame.new(fixPos)) * root.CFrame.Rotation
                    
                    -- 2. Triệt tiêu vận tốc hướng vào tường
                    -- Chuyển vận tốc sang hệ trục của tường
                    local velRel = BarrierPart.CFrame:VectorToObjectSpace(targetVelocity)
                    -- Nếu vận tốc đang hướng vào tường, chặn nó lại
                    if (pushDir == 1 and velRel.X < 0) or (pushDir == -1 and velRel.X > 0) then
                         velRel = Vector3.new(0, velRel.Y, velRel.Z) -- Xóa thành phần X
                    end
                    -- Chuyển ngược lại thế giới thực
                    targetVelocity = BarrierPart.CFrame:VectorToWorldSpace(velRel)
                end

                if BodyGyro then BodyGyro.CFrame = CFrame.lookAt(root.Position, root.Position + moveDir) end
            end
            
            BodyVel.Velocity = targetVelocity
            
        elseif IsEnabled and root and not root:FindFirstChild("ThinhFlyVelocity") then
            -- Nếu bị game xóa mất BodyVelocity (do chết hoặc lỗi), tự bật lại
            ApplyPhysics(char)
        end
    end
end)
